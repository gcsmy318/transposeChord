<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smye worship - Transpose Chord (Firebase A)</title>

<!-- Google font fallback: Sarabun (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ THSarabunNew ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å) -->
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- html2pdf / jspdf / html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#f5f7fa;
  --card:#ffffff;
  --border:#e6eef6;
  --muted:#6b7280;
  --accent:#0ea5e9;
  --accent-dark:#0284c7;
  --radius:10px;
  --text:#0f172a;
}

/* ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å THSarabunNew ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞ fallback ‡πÑ‡∏õ Sarabun/Tahoma */
@font-face{
  font-family: "THSarabunNew";
  src: local("THSarabunNew"), local("Sarabun"), local("Tahoma");
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"THSarabunNew", "Sarabun", "Tahoma", sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.topbar{
  max-width:1200px;margin:12px auto;padding:10px 14px;background:#fff;border-radius:10px;border:1px solid var(--border);display:flex;align-items:center;gap:12px;
}
h1{margin:0;font-size:18px}
.container{max-width:1200px;margin:12px auto;padding:12px;display:grid;grid-template-columns:280px 1fr 1fr;gap:14px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(12,18,32,0.04)}
/* sidebar */
.sidebar-list-item{display:flex;gap:10px;padding:10px;border-bottom:1px solid var(--border);align-items:flex-start}
.sidebar-list-item input{margin-top:6px}
.title{font-weight:700;color:#0f172a}
.youtube{font-size:12px;color:#475569;margin-top:4px}
.actions{display:flex;flex-direction:column;gap:8px}
.small{font-size:13px;color:var(--muted)}
.pdf-note{font-size:12px;color:var(--muted);margin-top:8px}

/* editor & preview */
textarea#editor{
  width:100%;
  height:420px;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  resize:vertical;
  font-family:"THSarabunNew", "Sarabun", "Tahoma", sans-serif;
  font-size:13px;
  line-height:1.45;
  color:var(--text);
}

.output{
  min-height:420px;
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  overflow:auto;
  font-family:"THSarabunNew", "Sarabun", "Tahoma", sans-serif;
  font-size:13px;
  line-height:1.45;
  white-space:pre-wrap;
  color:var(--text);
}

/* chord line */
.chordpro{
  font-family:"THSarabunNew", "Sarabun", "Tahoma", sans-serif;
  font-size:13px;
  font-weight:700;
  color:var(--accent-dark);
}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
.btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#f3f4f6;color:var(--text);border:1px solid var(--border)}
.key-buttons button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#f8fafc}

.muted{color:var(--muted);font-size:13px}

/* pdf list items */
.pdf-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
.pdf-item .meta{font-size:13px;color:#374151}

/* responsive / mobile A */
@media(max-width:980px){
  .container{grid-template-columns:1fr; padding:8px}
  .topbar{margin:8px;padding:8px}
}

/* Mobile top tab (‡πÅ‡∏ö‡∏ö A) */
.mobile-tabs{
  display:none;
  gap:8px;
  padding:8px;
  justify-content:center;
  background:#fff;
  border-bottom:1px solid var(--border);
}
@media(max-width:768px){
  .mobile-tabs{display:flex; position:sticky; top:0; z-index:20}
  /* hide all main sections by default; show by .show */
  #songListSection, #editorSection, #previewSection {
    display:none;
  }
  #songListSection.show, #editorSection.show, #previewSection.show {
    display:block;
  }
  /* make editor and preview full height scrollable */
  #editorSection, #previewSection, #songListSection {
    min-height:60vh;
  }
}
</style>
</head>
<body>

<div class="topbar">
  <h1>Smye worship - Transpose Chord</h1>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <div class="small" id="statusText" style="color:var(--muted)">Firestore: connecting‚Ä¶</div>
  </div>
</div>

<!-- Mobile tabs (‡πÅ‡∏ö‡∏ö A) -->
<div class="mobile-tabs" id="mobileTabs">
  <button id="tabList" class="btn secondary">üìö ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á</button>
  <button id="tabEditor" class="btn secondary">üéµ Editor</button>
  <button id="tabPreview" class="btn secondary">üìÑ Preview</button>
</div>

<div class="container">
  <!-- SIDEBAR / SONG LIST -->
  <section id="songListSection" class="card">
    <div style="font-weight:700;margin-bottom:10px">üéµ ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>

    <input id="songSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á..." style="width:100%;padding:8px;margin-bottom:10px;border:1px solid var(--border);border-radius:8px">

    <select id="keySearch" style="width:100%;padding:8px;margin-bottom:10px;border:1px solid var(--border);border-radius:8px">
      <option value="">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏µ‡∏¢‡πå (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
      <option value="C">C</option><option value="C#">C#</option><option value="D">D</option>
      <option value="D#">D#</option><option value="E">E</option><option value="F">F</option>
      <option value="F#">F#</option><option value="G">G</option><option value="G#">G#</option>
      <option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
    </select>

    <div id="songList"></div>
  </section>

  <!-- EDITOR -->
  <section id="editorSection" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">Editor</div>
        <div style="font-weight:700;margin-top:6px">‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á + ‡∏Ñ‡∏≠‡∏£‡πå‡∏î</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="loadSample" class="btn secondary">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <button id="saveSong" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏•‡∏á</button>
        <button id="clear" class="btn secondary">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <textarea id="editor" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á + ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>

    <div class="controls">
      <button id="dec" class="btn secondary">‚àí</button>
      <div id="transposeDisplay" style="font-weight:700">Transpose: 0</div>
      <button id="inc" class="btn secondary">+</button>

      <input id="range" type="range" min="-12" max="12" value="0" style="width:160px">
      <div id="stepsLabel" class="muted">0 semitones</div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="small">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå:</div>
        <div id="keyButtons" class="key-buttons"></div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="exportTxt" hidden class="btn secondary">Export .txt</button>
      <button id="exportDoc" class="btn secondary">Export .doc</button>
      <button id="exportPdf" class="btn">Export .pdf</button>
      <button id="printAsPdf" class="btn secondary">Print</button>
    </div>

    <div id="searchResults" style="margin-top:10px"></div>
  </section>

  <!-- PREVIEW -->
  <section id="previewSection" class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="small">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
        <div style="font-weight:700;margin-top:6px">Preview</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Possible Keys:</div>
        <div id="possibleKeys" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="preview" class="output" tabindex="0"></div>
  </section>
</div>

<!-- Firebase modular SDK via CDN (version can be adjusted) -->
<script type="module">
  // ----- Firebase config (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ) -----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDocs, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6yiFKFtyt69YWhlQ5GK3MsUgGrKU4c5w",
    authDomain: "smye-worship.firebaseapp.com",
    projectId: "smye-worship",
    storageBucket: "smye-worship.firebasestorage.app",
    messagingSenderId: "31357469768",
    appId: "1:31357469768:web:9e21798d7adbb6eeadc47d",
    measurementId: "G-JLZCZCMN53"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ----- Utilities -----
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function uuidv4(){ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,9); }

  // ----- Chord engine (same as before) -----
  const SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const FLATMAP = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
  const NOTE_TO_INDEX = {}; SHARP.forEach((n,i)=> NOTE_TO_INDEX[n] = i);

  function normNote(n){ if(!n) return n; return (FLATMAP[n] || n).toUpperCase(); }
  function isChordToken(tok){
    if(!tok) return false;
    let t = tok.trim().replace(/^[({\[]+|[)}\].,:!?]+$/g,"");
    if(/^(intro|verse|chorus|bridge|outro|pre-chorus|prechorus)$/i.test(t)) return false;
    return /^[A-G](#|b)?(m|min|maj|dim|aug|sus\d*|add\d*|maj7|m7|7|9|11|13)?(\/[A-G](#|b)?)?$/i.test(t);
  }
  function transposeRoot(root, steps){ const base = normNote(root); const idx = NOTE_TO_INDEX[base]; if(idx===undefined) return root; return SHARP[(idx+steps+12)%12]; }
  function transposeChordToken(tok, steps){
    const m = tok.match(/^([A-G](#|b)?)(.*?)(?:\/([A-G](#|b)?))?$/);
    if(!m) return tok;
    const root = m[1]; const mod = m[3] || ""; const bass = m[4] || "";
    const nr = transposeRoot(root, steps); const nb = bass ? transposeRoot(bass, steps) : "";
    return nb ? nr + mod + "/" + nb : nr + mod;
  }
  function processTokens(parts, steps){ return parts.map(p=>{ if(/^\s+$/.test(p)) return p; return isChordToken(p) ? transposeChordToken(p, steps) : p; }).join(''); }
  function isMostlyChordLine(line){ const toks = line.trim().split(/\s+/).filter(Boolean); if(toks.length===0) return false; let c=0; toks.forEach(t=>{ if(isChordToken(t)) c++; }); return (c/toks.length)>=0.5; }
  function transposeAll(text, steps){
    const out=[]; const lines = text.replace(/\r/g,'').split("\n");
    for(const line of lines){ if(line.trim()===""){ out.push(""); continue; } out.push(processTokens(line.split(/(\s+)/), steps)); }
    return out.join("\n");
  }
  function extractChords(text){
    const set = new Set();
    text.split("\n").forEach(line=>{ line.split(/(\s+)/).forEach(tok=>{ if(isChordToken(tok)) set.add(tok.trim()); }); });
    return [...set];
  }
  function detectPossibleKeys(tokens){
    const MAJOR = {"C":["C","Dm","Em","F","G","Am","Bdim"],"C#":["C#","D#m","Fm","F#","G#","A#m","Cdim"],"D":["D","Em","F#m","G","A","Bm","C#dim"],"D#":["D#","Fm","Gm","G#","A#","Cm","Ddim"],"E":["E","F#m","G#m","A","B","C#m","D#dim"],"F":["F","Gm","Am","A#","C","Dm","Edim"],"F#":["F#","G#m","A#m","B","C#","D#m","Fdim"],"G":["G","Am","Bm","C","D","Em","F#dim"],"G#":["G#","A#m","Cm","C#","D#","Fm","Gdim"],"A":["A","Bm","C#m","D","E","F#m","G#dim"],"A#":["A#","Cm","Dm","D#","F","Gm","Adim"],"B":["B","C#m","D#m","E","F#","G#m","A#dim"]};
    const roots = tokens.map(t=>{ const m = t.match(/^([A-G](#|b)?)(m|min|maj)?/i); if(!m) return null; const base = normNote(m[1]); const type = (m[3]||"").toLowerCase(); return (base + type).replace("maj",""); }).filter(Boolean);
    if(!roots.length) return [];
    let list=[];
    Object.keys(MAJOR).forEach(key=>{ const allowed = MAJOR[key]; const match = roots.filter(r=>allowed.includes(r)).length; const score = (match/roots.length)*100; if(score>0) list.push({key,score}); });
    return list.sort((a,b)=>b.score-a.score).slice(0,3);
  }
  function semitoneDiff(from,to){ const f=NOTE_TO_INDEX[normNote(from)]; const t=NOTE_TO_INDEX[normNote(to)]; if(f===undefined||t===undefined) return 0; return (t-f+12)%12; }

  // ----- DOM refs -----
  const editorEl = document.getElementById("editor");
  const previewEl = document.getElementById("preview");
  const transposeDisplay = document.getElementById("transposeDisplay");
  const stepsLabel = document.getElementById("stepsLabel");
  const range = document.getElementById("range");
  const statusText = document.getElementById("statusText");
  let currentSteps = 0;

  // ----- Firestore collection -----
  const songsCol = collection(db, "songs");

  // local cache
  let songsCache = [];

  // ----- Load songs from Firestore in realtime -----
  function subscribeSongsRealtime(){
    try{
      onSnapshot(songsCol, snap => {
        songsCache = [];
        snap.forEach(docSnap=>{
          const data = docSnap.data();
          songsCache.push(Object.assign({ id: docSnap.id }, data));
        });
        renderSongList();
        statusText.textContent = `Firestore: connected ‚Ä¢ ${songsCache.length} songs`;
      }, err => {
        console.error('snapshot err', err);
        statusText.textContent = 'Firestore: error';
      });
    }catch(e){
      console.error(e);
      statusText.textContent = 'Firestore: failed to subscribe';
    }
  }

  // ----- Add song (require password) -----
  async function addSongToFirestore(title, lyrics, youtube = ''){
    try{
      const payload = {
        title: title || ('Untitled ' + Date.now()),
        lyrics: lyrics || '',
        youtube: youtube || '',
        createdAt: Date.now()
      };
      await addDoc(songsCol, payload);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }catch(e){
      console.error(e); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message);
    }
  }

  // ----- Delete song by doc id (require password) -----
  async function deleteSongFromFirestore(id){
    try{
      await deleteDoc(doc(db, "songs", id));
      alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }catch(e){
      console.error(e); alert('‡∏•‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message);
    }
  }

  // ----- Render functions (with blank-line collapse for preview) -----
  function collapseBlankLines(text){
    // trim ends, replace 3+ blank lines with single blank line, also collapse 2+ to single
    return text.replace(/\r/g,'').split('\n')
      .map(line => line.replace(/\s+$/,''))
      .join('\n')
      .replace(/\n{2,}/g, '\n\n')
      .replace(/^\s*\n/, '')   // leading blank
      .replace(/\n\s*$/, '');  // trailing blank
  }

  function renderPreview(text){
    // remove extra blank lines first
    const cleaned = collapseBlankLines(text);
    // escape + render chords in bold color
    const esc = escapeHtml(cleaned);
    const html = esc.split("\n").map(line =>
      isMostlyChordLine(line)
        ? `<div class="chordpro">${line}</div>`
        : escapeHtml(line)
    ).join("\n");
    previewEl.innerHTML = html;
  }

  function renderSongList(filter=''){
    const q = (filter||'').toLowerCase().trim();
    const keyFilterEl = document.getElementById("keySearch");
    const keyFilter = keyFilterEl ? keyFilterEl.value : "";
    const box = document.getElementById('songList');
    const list = songsCache.filter(s=>{
      const lyrics = s.lyrics || "";
      const tokens = extractChords(lyrics);
      const possible = detectPossibleKeys(tokens);
      const songKey = possible.length ? possible[0].key : "";
      const matchText = (s.title||"").toLowerCase().includes(q) || lyrics.toLowerCase().includes(q);
      const matchKey = keyFilter === "" || songKey === keyFilter;
      return matchText && matchKey;
    });

    if(!list.length){
      box.innerHTML = '<div class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á</div>';
      return;
    }

    box.innerHTML = list.map(s=>{
      const lyrics = s.lyrics || "";
      const sampleLines = lyrics.split("\n").slice(0,2).map(line => escapeHtml(line)).join("<br>");
      const tokens = extractChords(lyrics);
      const possible = detectPossibleKeys(tokens);
      const songKey = possible.length ? possible[0].key : "-";
      return `
      <div class="sidebar-list-item" data-id="${s.id}">
        <input type="checkbox" class="song-check" value="${s.id}">
        <div style="flex:1">
          <div class="title">${escapeHtml(s.title)}</div>
          <div class="small" style="font-size:12px;color:#0ea5e9;margin-top:2px;">Key: ${songKey}</div>
          ${s.youtube ? `<div class="youtube">${escapeHtml(s.youtube)}</div>` : ""}
          <div class="small" style="margin-top:4px;color:#6b7280;font-size:12px;">${sampleLines}</div>
        </div>
        <div class="actions">
          <button class="btn secondary insert-btn" data-id="${s.id}">‡πÅ‡∏ó‡∏£‡∏Å</button>
          <button class="btn secondary load-btn" data-id="${s.id}">‡πÇ‡∏´‡∏•‡∏î</button>
          <button class="btn secondary delete-btn" data-id="${s.id}">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
    }).join('');

    // bind
    Array.from(box.querySelectorAll('.insert-btn')).forEach(b=> b.onclick = ()=> insertSongToEditor(b.dataset.id));
    Array.from(box.querySelectorAll('.load-btn')).forEach(b=> b.onclick = ()=> loadSong(b.dataset.id));
    Array.from(box.querySelectorAll('.delete-btn')).forEach(b=> b.onclick = ()=> {
      if(!confirm('‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ?')) return;
      const pass = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ');
      if(pass !== 'southhope'){ alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      deleteSongFromFirestore(b.dataset.id);
    });
  }

  // Insert / load functions
  function insertSongToEditor(id){
    const s = songsCache.find(x=>x.id===id);
    if(!s){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á'); return; }
    const txt = `\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n${s.title}\n${s.youtube?('YouTube: '+s.youtube+'\n'):''}${s.lyrics}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n\n`;
    const ta = editorEl;
    if(document.activeElement === ta){
      const start = ta.selectionStart, end = ta.selectionEnd;
      ta.value = ta.value.slice(0,start) + txt + ta.value.slice(end);
      ta.setSelectionRange(start + txt.length, start + txt.length);
    } else {
      if(ta.value && !ta.value.endsWith('\n')) ta.value += '\n';
      ta.value += txt;
    }
    updateUI();
    if(window.innerWidth <= 768) showSection('editorSection');
  }

  function loadSong(id){
    const s = songsCache.find(x=>x.id===id);
    if(!s) return;
    editorEl.value = s.lyrics || '';
    currentSteps = 0; updateUI();
    if(s.youtube){
      previewEl.innerHTML = `<div style="color:${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#0ea5e9'};margin-bottom:10px">üéµ YouTube: <a href="${s.youtube}" target="_blank">${s.youtube}</a></div>` + previewEl.innerHTML;
    }
    if(window.innerWidth <= 768) showSection('editorSection');
  }

  // ----- UI update & bindings -----
  function updateUI(){
    const text = editorEl.value || "";
    const transposedText = transposeAll(text, currentSteps);
    const tokens = extractChords(transposedText);
    const possible = detectPossibleKeys(tokens);
    document.getElementById("possibleKeys").innerHTML =
      possible.length ? possible.map(p=>`${p.key} (${p.score.toFixed(1)}%)`).join("<br>") : "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏î)";
    transposeDisplay.textContent = "Transpose: " + (currentSteps>=0?"+":"") + currentSteps;
    stepsLabel.textContent = currentSteps + " semitones";
    range.value = currentSteps;
    renderPreview(transposedText);
  }

  editorEl.addEventListener("input", updateUI);

  document.getElementById("dec").onclick = ()=>{
    currentSteps = Math.max(-12, currentSteps-1); updateUI();
  };
  document.getElementById("inc").onclick = ()=>{
    currentSteps = Math.min(12, currentSteps+1); updateUI();
  };
  range.oninput = e=>{ currentSteps = parseInt(e.target.value); updateUI(); };

  const ALL_KEYS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const keyButtonsEl = document.getElementById("keyButtons");
  ALL_KEYS.forEach(k=>{
    const b = document.createElement("button");
    b.textContent = k; b.className = "btn secondary"; b.style.padding = "6px 10px";
    b.onclick = ()=>{
      const tokens = extractChords(editorEl.value || "");
      const possible = detectPossibleKeys(tokens);
      const base = possible.length ? possible[0].key : "C";
      currentSteps = semitoneDiff(base, k);
      updateUI();
    };
    keyButtonsEl.appendChild(b);
  });

  // ----- Exports (use transposed text) -----
  document.getElementById("exportTxt").onclick = ()=>{
    const transposed = transposeAll(editorEl.value, currentSteps);
    const blob = new Blob([transposed], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "song.txt"; a.click();
  };

  document.getElementById("exportDoc").onclick = ()=>{
    const transposed = transposeAll(editorEl.value, currentSteps);
    const html = `<html><head><meta charset="utf-8"></head><body><pre style="font-family:THSarabunNew, Sarabun, Tahoma; white-space:pre-wrap;">${escapeHtml(transposed)}</pre></body></html>`;
    const blob = new Blob([html], {type:"application/msword"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "song.doc"; a.click();
  };

  document.getElementById("exportPdf").onclick = async ()=>{
    const { jsPDF } = window.jspdf;
    const transposed = transposeAll(editorEl.value, currentSteps);
    const div = document.createElement("div"); div.style.padding="20px"; div.style.background="#fff"; div.style.width="820px";
    div.innerHTML = `<div style="font-family:THSarabunNew, Sarabun, Tahoma; font-size:14px;"><pre style="white-space:pre-wrap; margin:0;">${escapeHtml(transposed)}</pre></div>`;
    document.body.appendChild(div);
    try {
      const canvas = await html2canvas(div, {scale:2, backgroundColor:"#FFFFFF"});
      const img = canvas.toDataURL("image/jpeg", 1.0);
      const pdf = new jsPDF("p","pt","a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const ratio = canvas.height / canvas.width;
      pdf.addImage(img,"JPEG",0,0,pageWidth,pageWidth * ratio);
      pdf.save("song.pdf");
    } catch(e){
      console.error(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF");
    }
    document.body.removeChild(div);
  };

  document.getElementById("printAsPdf").onclick = ()=>{
    const transposed = transposeAll(editorEl.value, currentSteps);
    const w = window.open("","_blank");
    w.document.write(`<html><head><meta charset="utf-8"><style>body{font-family:THSarabunNew, Sarabun, Tahoma;padding:20px;white-space:pre-wrap;}</style></head><body>${escapeHtml(transposed)}</body></html>`);
    w.document.close(); w.focus(); w.print();
  };

  // ----- Init / UI boot -----
  window.addEventListener('DOMContentLoaded', async ()=>{
    // subscribe to songs
    subscribeSongsRealtime();

    // search inputs
    document.getElementById('songSearch').addEventListener('input', e=>{
      renderSongList(e.target.value);
    });
    document.getElementById('keySearch').addEventListener('change', ()=> renderSongList(document.getElementById('songSearch').value) );

    // sample / save / clear
    document.getElementById('loadSample').onclick = ()=>{
      editorEl.value = `[‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á]
C G Am F
‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á`;
      currentSteps = 0; updateUI();
    };

    document.getElementById('saveSong').onclick = async ()=>{
      const pass = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏•‡∏á ');
      if(pass !== 'southhope'){ alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      const title = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á?');
      if(!title) return;
      const lyrics = editorEl.value || '';
      // optional youtube prompt
      const youtube = prompt('YouTube URL (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)') || '';
      await addSongToFirestore(title, lyrics, youtube);
    };

    document.getElementById('clear').onclick = ()=>{
      if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Editor?')){ editorEl.value = ''; currentSteps = 0; updateUI(); }
    };

    // mobile tabs default
    if(window.innerWidth <= 768){
      showSection('editorSection');
    } else {
      document.getElementById('songListSection').classList.add('show');
      document.getElementById('editorSection').classList.add('show');
      document.getElementById('previewSection').classList.add('show');
    }
    updateUI();
  });

  // ----- Mobile tabs -----
  function showSection(id){
    ['songListSection','editorSection','previewSection'].forEach(x=>{
      const el = document.getElementById(x); if(el) el.classList.remove('show');
    });
    const el = document.getElementById(id); if(el) el.classList.add('show');
    window.scrollTo(0,0);
  }
  document.getElementById('tabList').onclick = ()=> showSection('songListSection');
  document.getElementById('tabEditor').onclick = ()=> showSection('editorSection');
  document.getElementById('tabPreview').onclick = ()=> showSection('previewSection');

  window.addEventListener('resize', ()=>{
    if(window.innerWidth <= 768){
      if(!document.getElementById('songListSection').classList.contains('show') &&
         !document.getElementById('editorSection').classList.contains('show') &&
         !document.getElementById('previewSection').classList.contains('show')){
           showSection('editorSection');
      }
    } else {
      document.getElementById('songListSection').classList.add('show');
      document.getElementById('editorSection').classList.add('show');
      document.getElementById('previewSection').classList.add('show');
    }
  });

</script>
</body>
</html>
